name: 同步代码并创建PR

on:
  workflow_dispatch: # 仅手动触发

jobs:
  sync-and-pr:
    runs-on: ubuntu-latest
    steps:
      - name: 检出当前仓库
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 配置Git
        run: |
          git config --global user.name "DarkFlameMaster"
          git config --global user.email "actions@github.com"
          # 配置SSH
          git config --global url."git@github.com:".insteadOf "https://github.com/"

      - name: 设置SSH密钥
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: 克隆fork仓库
        uses: actions/checkout@v4
        with:
          repository: 1004452714/bettergi-scripts-list
          ref: main
          path: fork
          token: ${{ secrets.SYNC_TOKEN }}
          fetch-depth: 0
          sparse-checkout: |
            repo/js/AutoCommission
      
      - name: 添加上游仓库
        run: |
          cd fork
          git remote add upstream https://github.com/babalae/bettergi-scripts-list.git
      
      - name: 同步上游仓库（变基）
        run: |
          cd fork
          # 获取上游仓库的最新代码
          git fetch upstream main
          # 变基同步到上游仓库
          git rebase upstream/main
          # 如果变基成功，推送更新到fork仓库
          git push origin main --force-with-lease
      
      - name: 创建唯一分支名
        id: create-branch-name
        run: |
          # 生成包含时间戳的唯一分支名
          BRANCH_NAME="sync-auto-commission-$(date +%Y%m%d%H%M%S)"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: 在fork仓库中创建新分支
        run: |
          cd fork
          git checkout -b ${{ steps.create-branch-name.outputs.branch_name }}

      - name: 同步代码到fork仓库
        run: |
          # 清空目标目录
          rm -rf fork/repo/js/AutoCommission/*
          # 复制代码，排除指定目录和文件
          rsync -av --exclude='.idea' --exclude='.github' --exclude='LICENSE' --exclude='Sync-To-Fork.ps1' --exclude='fork' ./ fork/repo/js/AutoCommission/

      - name: 获取上次同步的哈希值
        id: get-last-hash
        run: |
          LAST_HASH_FILE="fork/repo/js/AutoCommission/.last_sync_hash"
          if [ -f "$LAST_HASH_FILE" ]; then
            LAST_HASH=$(cat "$LAST_HASH_FILE")
            echo "last_hash=$LAST_HASH" >> $GITHUB_OUTPUT
          else
            echo "last_hash=" >> $GITHUB_OUTPUT
          fi

      - name: 获取提交记录
        id: get-commit-messages
        run: |
          if [ -n "${{ steps.get-last-hash.outputs.last_hash }}" ]; then
            COMMITS=$(git log ${{ steps.get-last-hash.outputs.last_hash }}..HEAD --pretty=format:"- %h %s")
            echo "has_commits=true" >> $GITHUB_OUTPUT
          else
            COMMITS=""
            echo "has_commits=false" >> $GITHUB_OUTPUT
          fi
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: 保存当前哈希值
        run: |
          CURRENT_HASH=$(git rev-parse HEAD)
          echo "$CURRENT_HASH" > fork/repo/js/AutoCommission/.last_sync_hash

      - name: 检查是否有更改需要提交
        id: check-changes
        run: |
          cd fork
          git add repo/js/AutoCommission/*
          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: 提交并推送代码到fork仓库
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          cd fork
          git commit -m "同步AutoCommission更新"
          git push origin ${{ steps.create-branch-name.outputs.branch_name }}

      - name: 使用GitHub API创建PR
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          # 生成PR的body内容
          PR_BODY="此PR同步了AutoCommission仓库的最新更新。${{ steps.get-commit-messages.outputs.has_commits == 'true' && '\n\n上次同步以来的变更：\n${{ steps.get-commit-messages.outputs.commits }}' || '' }}"
          
          # 使用curl调用GitHub API创建PR
          curl -X POST \
            -H "Authorization: token ${{ secrets.SYNC_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/babalae/bettergi-scripts-list/pulls \
            -d '{"title": "同步AutoCommission更新", "body": "'"$PR_BODY"'", "head": "1004452714:${{ steps.create-branch-name.outputs.branch_name }}", "base": "main"}'
